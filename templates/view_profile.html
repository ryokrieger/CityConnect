<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Profile - CityConnect</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/users/profile.css') }}">
</head>
<body>
    <div class="header">
        <a href="javascript:history.back()">← Back to Previous Page</a>
    </div>

    <div class="container">

        <!-- Error alert for "not friends" -->
        {% if request.args.get('error') == 'not_friends' %}
            <div class="alert error-alert">
                You need to be friends to give a rating
            </div>
        {% endif %}

        <!-- Profile title -->
        <div class="profile-header">
            <h1>{{ profile.username or 'User Profile' }}</h1>
        </div>

        <!-- Basic Information section -->
        <div class="card">
            <h3>Basic Information</h3>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ profile.email or 'Not specified' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">City:</span>
                <span class="info-value">{{ profile.city_name or 'Not specified' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Neighborhood:</span>
                <span class="info-value">{{ profile.area_name or 'Not specified' }}</span>
            </div>
        </div>

        <!-- Interests section -->
        <div class="card">
            <h3>Interests</h3>
            {% if interests %}
                <div class="interests">
                    {% for interest in interests %}
                        <span class="interest-tag">{{ interest }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-message">This user has not selected any interests.</p>
            {% endif %}
        </div>

        <!-- Community Rating section -->
        <div class="card">
            <h3>Community Rating</h3>
            <div class="rating-box">
                <div class="rating-number">{{ avg_rating or '0.0' }}</div>
                <div class="stars">
                    {% set rating = avg_rating|float if avg_rating else 0 %}
                    {% for i in range(5) %}
                        {% if i < rating %}★{% else %}☆{% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Rating form section -->
        <div class="card">
            <h3>Your Rating</h3>
            <form method="POST" action="{{ url_for('rate_user', profile_user_id=profile_user_id) }}">
                <div class="form-group">
                    <label for="rating">Rate (1–5):</label>
                    <select name="rating" id="rating" required>
                        {% for i in range(1, 6) %}
                            <option value="{{ i }}" {% if your_rating and your_rating.rating == i %}selected{% endif %}>{{ i }} Star{{ 's' if i != 1 else '' }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="comment">Comment:</label>
                    <textarea name="comment" id="comment" placeholder="Share your experience with this user...">{{ your_rating.comments if your_rating else '' }}</textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn">
                        {% if your_rating %}Update Rating{% else %}Submit Rating{% endif %}
                    </button>
                </div>
            </form>

            <!-- Delete rating button if a rating exists -->
            {% if your_rating %}
                <form method="POST" action="{{ url_for('delete_rating', profile_user_id=profile_user_id) }}" style="margin-top: 12px;">
                    <button type="submit" class="btn btn-delete">Delete Your Rating</button>
                </form>
            {% endif %}
        </div>

        <!-- All reviews section -->
        <div class="card">
            <h3>All Reviews</h3>
            {% if reviews %}
                {% for review in reviews %}
                    <div class="review">
                        <div class="review-header">
                            <span class="reviewer-name">{{ review.username }}</span>
                            <span class="review-rating">{{ review.rating }}/5</span>
                        </div>
                        {% if review.comments %}
                            <div class="review-comment">"{{ review.comments }}"</div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="empty-message">No reviews yet.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>